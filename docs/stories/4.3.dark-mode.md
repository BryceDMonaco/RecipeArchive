# Story 4.3: Dark Mode Implementation - Brownfield Addition

## User Story

**As a** user,
**I want** to toggle between light and dark color themes,
**So that** I can use the Recipe Archive comfortably in different lighting conditions and match my personal preference.

## Story Context

### Existing System Integration

- **Integrates with:**
  - shadcn/ui theming system (CSS variables and `ThemeProvider`)
  - Tailwind CSS configuration
  - Sidebar component (for toggle placement)
  - All existing shadcn/ui components (Button, Card, Sheet, etc.)
- **Technology:** shadcn/ui theme provider, CSS variables, React Context, localStorage
- **Follows pattern:** shadcn/ui theming documentation, React Context for global state
- **Touch points:**
  - Root component (`src/main.tsx` or `src/App.tsx`)
  - Sidebar component (add theme toggle)
  - Tailwind config (`tailwind.config.js`)
  - CSS variables (`src/index.css`)
  - localStorage for theme persistence

### Feature to Implement

Implement dark mode using shadcn/ui's built-in theming system with:
- Dark mode enabled by default
- Theme toggle button in the sidebar (simple moon/sun icon button)
- Theme preference persists across browser sessions (localStorage)
- Smooth transitions between themes
- All components automatically adapt to theme changes

## Acceptance Criteria

### Functional Requirements

1. Dark mode is enabled by default on first visit
2. Theme toggle button visible in sidebar (desktop and mobile)
3. Clicking toggle switches between light and dark themes instantly
4. Theme preference persists across browser sessions (stored in localStorage)
5. All shadcn/ui components adapt correctly to theme changes (buttons, cards, inputs, sheet overlay)
6. Custom components respect theme (RecipeDisplay, SearchBar, TagFilter, etc.)
7. Theme toggle button shows appropriate icon (moon for light mode, sun for dark mode)

### Integration Requirements

8. Existing sidebar layout and functionality unchanged (toggle doesn't disrupt navigation)
9. New theme toggle follows shadcn/ui Button component pattern
10. Integration with Tailwind dark mode (`class` strategy recommended)
11. All existing components continue to work without modifications (dark mode classes already in Tailwind)
12. Print CSS forces light mode for printed recipes (ink-saving)

### Quality Requirements

13. Color contrast in dark mode meets WCAG AA standards (minimum 4.5:1 for text)
14. Theme transitions are smooth (CSS transitions on color changes)
15. Component tests updated to handle both themes
16. Lighthouse accessibility score maintains 90+ in both light and dark modes
17. Manual testing in both themes verifies no visual issues

## Technical Notes

### Integration Approach

**Step 1: Install shadcn/ui theme dependencies (if not already installed)**

```bash
# May already be present; verify package.json
npm install next-themes
```

**Step 2: Setup Tailwind dark mode**

Update `tailwind.config.js`:
```typescript
module.exports = {
  darkMode: ['class'], // Enable class-based dark mode
  // ... rest of config
}
```

**Step 3: Create ThemeProvider wrapper**

Create `src/components/theme-provider.tsx`:
```typescript
import { createContext, useContext, useEffect, useState } from 'react'

type Theme = 'dark' | 'light'

type ThemeProviderProps = {
  children: React.ReactNode
  defaultTheme?: Theme
}

const ThemeProviderContext = createContext<{
  theme: Theme
  setTheme: (theme: Theme) => void
} | undefined>(undefined)

export function ThemeProvider({ children, defaultTheme = 'dark' }: ThemeProviderProps) {
  const [theme, setTheme] = useState<Theme>(() => {
    const stored = localStorage.getItem('recipe-archive-theme')
    return (stored as Theme) || defaultTheme
  })

  useEffect(() => {
    const root = window.document.documentElement
    root.classList.remove('light', 'dark')
    root.classList.add(theme)
    localStorage.setItem('recipe-archive-theme', theme)
  }, [theme])

  return (
    <ThemeProviderContext.Provider value={{ theme, setTheme }}>
      {children}
    </ThemeProviderContext.Provider>
  )
}

export const useTheme = () => {
  const context = useContext(ThemeProviderContext)
  if (!context) {
    throw new Error('useTheme must be used within ThemeProvider')
  }
  return context
}
```

**Step 4: Wrap App with ThemeProvider**

In `src/main.tsx` or `src/App.tsx`:
```typescript
import { ThemeProvider } from '@/components/theme-provider'

// In render:
<ThemeProvider defaultTheme="dark">
  <App />
</ThemeProvider>
```

**Step 5: Create ThemeToggle component**

Create `src/components/theme-toggle.tsx`:
```typescript
import { Moon, Sun } from 'lucide-react'
import { Button } from '@/components/ui/button'
import { useTheme } from '@/components/theme-provider'

export function ThemeToggle() {
  const { theme, setTheme } = useTheme()

  return (
    <Button
      variant="ghost"
      size="icon"
      onClick={() => setTheme(theme === 'light' ? 'dark' : 'light')}
      aria-label={`Switch to ${theme === 'light' ? 'dark' : 'light'} mode`}
    >
      {theme === 'light' ? <Moon className="h-5 w-5" /> : <Sun className="h-5 w-5" />}
    </Button>
  )
}
```

**Step 6: Add ThemeToggle to Sidebar**

In `src/components/layout/Sidebar.tsx`, add toggle to header:
```typescript
<div className="flex h-16 items-center justify-between border-b px-6">
  <h1 className="text-xl font-bold tracking-tight">Recipe Archive</h1>
  <div className="flex gap-2">
    <ThemeToggle />
    {/* Existing mobile close button */}
  </div>
</div>
```

**Step 7: Update CSS for dark mode colors**

Ensure `src/index.css` has dark mode CSS variables (shadcn should have this already):
```css
@layer base {
  :root {
    --background: 0 0% 100%;
    --foreground: 222.2 84% 4.9%;
    /* ... other light mode variables */
  }

  .dark {
    --background: 222.2 84% 4.9%;
    --foreground: 210 40% 98%;
    /* ... other dark mode variables */
  }
}
```

**Step 8: Force light mode for print**

Add to print CSS:
```css
@media print {
  html {
    color-scheme: light;
  }
  .dark {
    color-scheme: light;
    /* Override dark mode for printing */
  }
}
```

### Existing Pattern Reference

- shadcn/ui theming docs: https://ui.shadcn.com/docs/dark-mode
- shadcn/ui dark mode guide: https://ui.shadcn.com/docs/dark-mode/vite
- Tailwind dark mode: https://tailwindcss.com/docs/dark-mode
- Current Sidebar implementation: `src/components/layout/Sidebar.tsx`

### Key Constraints

- Must use shadcn/ui theming system (don't create custom solution)
- Default theme must be dark (as specified in requirements)
- Theme toggle must be accessible (ARIA labels, keyboard navigation)
- Print output must always be light mode (ink-saving)
- Color transitions should be smooth but not distracting
- localStorage key should be namespaced (e.g., `recipe-archive-theme`)

## Definition of Done

- [x] Functional requirements met (dark default, toggle works, persistence)
- [x] Integration requirements verified (sidebar unchanged, Tailwind dark mode configured)
- [x] Existing functionality regression tested (all components work in both themes)
- [x] Code follows existing patterns and standards (shadcn/ui, React Context, TypeScript)
- [x] Tests pass (component tests handle theme changes)
- [x] Color contrast verified in both themes (automated tool like WAVE or Lighthouse)
- [x] Manual testing completed in both light and dark modes
- [x] Print CSS forces light mode verified

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Dark mode could introduce color contrast issues or make some components unreadable

**Mitigation:**
- Use shadcn/ui's pre-configured dark mode CSS variables (tested for accessibility)
- Run Lighthouse accessibility audit in both light and dark modes
- Manually verify all text is readable in both themes
- Test with Chrome DevTools color contrast analyzer

**Secondary Risk:** Custom components (RecipeDisplay, SearchBar) might not respect dark mode

**Mitigation:**
- Use Tailwind's dark mode classes where needed (e.g., `dark:bg-gray-800`)
- Ensure all components use semantic color variables (`bg-background`, `text-foreground`)
- Test all components in both themes during manual testing

**Rollback:** Remove ThemeProvider wrapper and ThemeToggle component; revert localStorage changes

### Compatibility Verification

- [x] No breaking changes to existing APIs (ThemeProvider wraps App, no prop changes)
- [x] Database changes (if any) are additive only (N/A - localStorage only)
- [x] UI changes follow existing design patterns (shadcn/ui Button, Context API)
- [x] Performance impact is negligible (CSS variable updates are fast, localStorage reads are cached)

## Validation Checklist

### Scope Validation

- [x] Story can be completed in one development session (3-5 hours including testing)
- [x] Integration approach is straightforward (shadcn/ui theming, well-documented)
- [x] Follows existing patterns exactly (shadcn/ui components, React Context)
- [x] No architectural work required (uses existing patterns)

### Clarity Check

- [x] Story requirements are unambiguous (clear feature specification)
- [x] Integration points are clearly specified (ThemeProvider, Sidebar, Tailwind config)
- [x] Success criteria are testable (toggle works, themes persist, contrast verified)
- [x] Rollback approach is simple (remove theme components and provider)

## Testing Guidance

### Component Tests

```typescript
// Add to Sidebar.test.tsx
test('Sidebar renders theme toggle button', () => {
  render(<Sidebar><div>Test</div></Sidebar>);
  expect(screen.getByLabelText(/switch to.*mode/i)).toBeInTheDocument();
});

// Add ThemeToggle.test.tsx
describe('ThemeToggle', () => {
  test('toggles between light and dark themes', () => {
    render(<ThemeToggle />);
    const button = screen.getByRole('button');
    fireEvent.click(button);
    // Assert theme changed in context
  });

  test('persists theme to localStorage', () => {
    render(<ThemeToggle />);
    const button = screen.getByRole('button');
    fireEvent.click(button);
    expect(localStorage.getItem('recipe-archive-theme')).toBe('light');
  });
});
```

### Manual Testing Checklist

**Theme Toggle Functionality:**
- [ ] Default theme is dark on first visit
- [ ] Theme toggle button visible in sidebar (desktop and mobile)
- [ ] Clicking toggle switches to light mode
- [ ] Clicking again switches back to dark mode
- [ ] Icon changes appropriately (moon â†” sun)

**Persistence:**
- [ ] Selected theme persists after page refresh
- [ ] localStorage contains correct theme value
- [ ] Different browser tabs respect theme choice

**Visual Verification (Both Themes):**
- [ ] All text is readable (sufficient contrast)
- [ ] Buttons have clear focus states
- [ ] Sidebar styling looks good
- [ ] Recipe content is readable
- [ ] Search and filter components look correct
- [ ] No "flashing" or FOUC (flash of unstyled content) on load

**Accessibility:**
- [ ] Theme toggle has descriptive ARIA label
- [ ] Theme toggle is keyboard accessible (Tab + Enter)
- [ ] Color contrast meets WCAG AA (4.5:1 minimum for normal text)
- [ ] Lighthouse accessibility score 90+ in both themes

**Print:**
- [ ] Print preview shows light theme regardless of current theme
- [ ] Printed recipe is legible (no dark backgrounds)
