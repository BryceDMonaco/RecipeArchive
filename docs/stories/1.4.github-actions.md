# Story 1.4: GitHub Actions CI/CD Pipeline

## Status

Draft

## Story

**As a** developer,
**I want** automated build and deployment to GitHub Pages on every push to main,
**so that** recipe changes and code updates are automatically published.

## Acceptance Criteria

1. GitHub Actions workflow file created (`.github/workflows/deploy.yml`)
2. Workflow triggers on push to `main` branch
3. Workflow runs `npm install` and `npm run build`
4. Workflow runs tests (`npm test`) before building
5. Build output (`/dist`) deployed to `gh-pages` branch
6. GitHub Pages configured to serve from `gh-pages` branch
7. Site accessible via GitHub Pages URL after workflow completes
8. Workflow fails if tests fail (preventing broken builds from deploying)
9. Sample recipe visible on deployed site

## Tasks / Subtasks

- [ ] Create GitHub Actions workflow file (AC: 1, 2)
  - [ ] Create `.github/workflows/deploy.yml`
  - [ ] Configure workflow to trigger on push to main branch
  - [ ] Add workflow_dispatch for manual triggers
  - [ ] Set permissions for GitHub Pages deployment

- [ ] Configure build environment (AC: 3)
  - [ ] Set up ubuntu-latest runner
  - [ ] Checkout repository with actions/checkout@v4
  - [ ] Setup Node.js 18 with actions/setup-node@v4
  - [ ] Enable npm caching for faster builds
  - [ ] Run `npm ci` (clean install from lockfile)

- [ ] Add linting and testing steps (AC: 4, 8)
  - [ ] Add lint step: `npm run lint`
  - [ ] Add test step: `npm run test` (or `npm run test:coverage`)
  - [ ] Configure steps to fail workflow on error
  - [ ] Ensure tests run before build step

- [ ] Configure build step (AC: 3)
  - [ ] Run `npm run build` with NODE_ENV=production
  - [ ] Verify /dist directory is created
  - [ ] Upload build artifacts using actions/upload-pages-artifact@v3

- [ ] Set up GitHub Pages deployment (AC: 5, 6)
  - [ ] Create separate deploy job that depends on build
  - [ ] Use actions/deploy-pages@v4 action
  - [ ] Configure environment name as "github-pages"
  - [ ] Set concurrency to prevent multiple simultaneous deployments

- [ ] Configure repository settings (AC: 6, 7)
  - [ ] Navigate to repository Settings > Pages
  - [ ] Set source to "GitHub Actions"
  - [ ] Verify Pages is enabled for the repository
  - [ ] Note the GitHub Pages URL (https://username.github.io/RecipeArchive)

- [ ] Test end-to-end deployment (AC: 7, 9)
  - [ ] Push changes to main branch
  - [ ] Monitor workflow execution in Actions tab
  - [ ] Verify workflow completes successfully
  - [ ] Visit GitHub Pages URL
  - [ ] Confirm sample recipe is visible

- [ ] Test failure scenarios (AC: 8)
  - [ ] Intentionally break a test
  - [ ] Push to main and verify workflow fails
  - [ ] Verify deployment does not occur on test failure
  - [ ] Fix test and verify workflow succeeds

## Dev Notes

### Relevant Architecture Information

**Tech Stack:**
- **CI/CD:** GitHub Actions
- **Deployment:** GitHub Pages
- **Build Tool:** Vite
- **Testing:** Vitest

**Deployment Architecture (from Architecture):**

**Deployment Strategy:**
- Platform: GitHub Pages (free static hosting)
- Build command: `npm run build`
- Output directory: `dist/`
- Deployment: gh-pages branch
- Trigger: Push to main branch

**Workflow Structure:**
1. **Build Job:**
   - Install dependencies
   - Run linting
   - Run tests with coverage
   - Build application
   - Upload artifacts

2. **Deploy Job:**
   - Deploy artifacts to GitHub Pages
   - Only runs if build succeeds

**Environment URLs (from Architecture):**
- Production: `https://<username>.github.io/RecipeArchive`
- Development: `http://localhost:5173` (local only)

**Complete Workflow YAML (from Architecture):**

```yaml
# .github/workflows/deploy.yml
name: Deploy to GitHub Pages

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger

# Set permissions for GitHub Pages deployment
permissions:
  contents: read
  pages: write
  id-token: write

# Allow only one concurrent deployment
concurrency:
  group: "pages"
  cancel-in-progress: true

jobs:
  build:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '18'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Run linter
        run: npm run lint

      - name: Run tests
        run: npm run test:coverage

      - name: Build application
        run: npm run build
        env:
          NODE_ENV: production

      - name: Upload build artifacts
        uses: actions/upload-pages-artifact@v3
        with:
          path: ./dist

  deploy:
    needs: build
    runs-on: ubuntu-latest

    environment:
      name: github-pages
      url: ${{ steps.deployment.outputs.page_url }}

    steps:
      - name: Deploy to GitHub Pages
        id: deployment
        uses: actions/deploy-pages@v4
```

**Vite Configuration for GitHub Pages:**

```typescript
// vite.config.ts
import { defineConfig } from 'vite'
import react from '@vitejs/plugin-react'
import path from 'path'

export default defineConfig({
  plugins: [react()],
  base: '/RecipeArchive/', // Must match repository name
  resolve: {
    alias: {
      '@': path.resolve(__dirname, './src'),
    },
  },
})
```

**Important Notes:**
- `base` in vite.config.ts must match GitHub repository name
- GitHub Pages URL: `https://<username>.github.io/<repo-name>/`
- For custom domain: Add CNAME file to `/public` directory
- Workflow uses `npm ci` not `npm install` for reproducible builds

**Package.json Test Scripts:**

Ensure these scripts exist:
```json
{
  "scripts": {
    "test": "vitest",
    "test:coverage": "vitest run --coverage"
  }
}
```

**Critical Standards:**
- Never skip tests in CI/CD (no `--no-verify` flags)
- Always use `npm ci` in CI environments (not `npm install`)
- Set NODE_ENV=production for production builds
- Use specific action versions (e.g., @v4, not @latest)
- Enable concurrency control to prevent deploy race conditions

**Permissions Required:**
- `contents: read` - Read repository code
- `pages: write` - Deploy to GitHub Pages
- `id-token: write` - OIDC token for deployment

### Testing

**Manual Testing Required:**

This story requires manual verification rather than automated tests:

1. **Workflow Syntax Validation:**
   - GitHub validates YAML syntax on commit
   - Verify workflow appears in Actions tab

2. **Build Success Test:**
   - Push to main
   - Monitor workflow in Actions tab
   - Verify all steps complete (green checkmarks)
   - Check build artifacts were created

3. **Deployment Verification:**
   - Visit GitHub Pages URL
   - Verify site loads correctly
   - Check sample recipe displays
   - Test navigation and basic functionality

4. **Failure Scenario Test:**
   - Break a test intentionally
   - Push to main
   - Verify workflow fails at test step
   - Verify deployment does not occur
   - Fix test and verify recovery

**No Automated Tests:**
- CI/CD infrastructure is tested by execution
- Workflow itself cannot be unit tested
- Integration test is the deployment itself

**Quality Checks:**
- Workflow completes in <3 minutes
- No warnings in workflow logs
- Build artifacts size <10MB (check Actions artifacts)
- Deployed site loads in <2 seconds

## Change Log

| Date | Version | Description | Author |
|------|---------|-------------|--------|
| 2025-12-08 | 1.0 | Initial story creation | John (PM) |

## Dev Agent Record

### Agent Model Used

_To be populated by dev agent_

### Debug Log References

_To be populated by dev agent_

### Completion Notes

_To be populated by dev agent_

### File List

_To be populated by dev agent_

## QA Results

_To be populated by QA agent_
