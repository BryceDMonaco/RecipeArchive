# Story 4.4: UI/UX Polish and Refinements - Brownfield Addition

## User Story

**As a** user,
**I want** to dismiss the work-in-progress banner and have the copy ingredients button more accessible,
**So that** I can have a cleaner interface and quickly access the copy functionality without scrolling.

## Story Context

### Existing System Integration

- **Integrates with:**
  - DevBanner component (`src/components/layout/DevBanner.tsx`)
  - RecipeDisplay component (`src/components/recipe/RecipeDisplay.tsx`)
  - CopyIngredientsButton component (`src/components/recipe/CopyIngredientsButton.tsx`)
  - Layout component (renders DevBanner)
- **Technology:** React, TypeScript, localStorage, shadcn/ui components
- **Follows pattern:** shadcn/ui Button, React state management, localStorage persistence
- **Touch points:**
  - DevBanner component (add dismiss functionality)
  - RecipeDisplay component (move copy button placement)
  - localStorage (persist banner dismiss state)
  - CopyIngredientsButton (may need to accept position/styling props)

### Features to Implement

1. **Dismissible WIP Banner:** Add an X button in the top left of the red work-in-progress banner to allow users to close/hide it permanently (or until localStorage is cleared)
2. **Improved Copy Button Placement:** Move the "Copy Ingredients" button from the bottom of the recipe to immediately below the "Ingredients" header for better accessibility

## Acceptance Criteria

### Functional Requirements

1. WIP banner displays an X button/icon in the top left corner
2. Clicking the X button hides the banner immediately
3. Banner dismiss state persists across browser sessions (localStorage)
4. Once dismissed, banner does not reappear unless localStorage is cleared
5. Copy Ingredients button appears immediately below the "Ingredients" heading (before the ingredient list)
6. Copy button still copies all ingredients correctly (existing functionality maintained)
7. If no "Ingredients" heading is found, button falls back to current bottom placement

### Integration Requirements

8. Existing DevBanner styling and message unchanged (only add dismiss button)
9. New dismiss functionality follows React state management patterns
10. RecipeDisplay component maintains existing markdown rendering
11. CopyIngredientsButton maintains existing clipboard functionality
12. Banner dismiss doesn't affect other components or layout

### Quality Requirements

13. Changes are covered by component tests (DevBanner, RecipeDisplay)
14. localStorage key is namespaced (e.g., `recipe-archive-banner-dismissed`)
15. No regression in existing copy ingredients functionality
16. Dismiss button is accessible (ARIA label, keyboard navigation)
17. Copy button placement looks visually appropriate in all themes (light/dark)

## Technical Notes

### Integration Approach

**Part 1: Dismissible WIP Banner**

Update `src/components/layout/DevBanner.tsx`:

```typescript
import { useState, useEffect } from 'react';
import { X } from 'lucide-react';
import { Button } from '@/components/ui/button';

const STORAGE_KEY = 'recipe-archive-banner-dismissed';

export function DevBanner() {
  const [isDismissed, setIsDismissed] = useState(() => {
    return localStorage.getItem(STORAGE_KEY) === 'true';
  });

  const handleDismiss = () => {
    setIsDismissed(true);
    localStorage.setItem(STORAGE_KEY, 'true');
  };

  if (isDismissed) {
    return null;
  }

  return (
    <div className="bg-destructive text-destructive-foreground relative">
      <div className="container mx-auto px-4 py-2 text-center text-sm font-medium">
        <Button
          variant="ghost"
          size="icon"
          className="absolute left-2 top-1/2 -translate-y-1/2 h-6 w-6 text-destructive-foreground hover:bg-destructive-foreground/20"
          onClick={handleDismiss}
          aria-label="Dismiss banner"
        >
          <X className="h-4 w-4" />
        </Button>
        ⚠️ This site is currently in development and is a work in progress
      </div>
    </div>
  );
}
```

**Part 2: Move Copy Button Placement**

Update `src/components/recipe/RecipeDisplay.tsx`:

Current implementation:
```typescript
export function RecipeDisplay({ recipe }: RecipeDisplayProps) {
  return (
    <article className="prose prose-zinc max-w-3xl">
      <h1>{recipe.title}</h1>
      <ReactMarkdown remarkPlugins={[remarkGfm]}>{recipe.content}</ReactMarkdown>
      <div className="not-prose my-6">
        <CopyIngredientsButton content={recipe.content} />
      </div>
    </article>
  );
}
```

New implementation strategy:
- Parse recipe content to detect "## Ingredients" heading
- Split content into sections (before ingredients, ingredients section, after ingredients)
- Render copy button immediately after ingredients heading
- If no ingredients heading found, fall back to current bottom placement

```typescript
export function RecipeDisplay({ recipe }: RecipeDisplayProps) {
  // Check if content has "## Ingredients" heading
  const hasIngredientsHeading = /^##\s+Ingredients/m.test(recipe.content);

  if (hasIngredientsHeading) {
    // Split content at Ingredients heading
    const parts = recipe.content.split(/^(##\s+Ingredients)/m);
    const beforeIngredients = parts[0] || '';
    const ingredientsHeading = parts[1] || '';
    const afterIngredients = parts[2] || '';

    return (
      <article className="prose prose-zinc max-w-3xl">
        <h1>{recipe.title}</h1>
        <ReactMarkdown remarkPlugins={[remarkGfm]}>{beforeIngredients}</ReactMarkdown>
        <ReactMarkdown remarkPlugins={[remarkGfm]}>{ingredientsHeading}</ReactMarkdown>
        <div className="not-prose my-4">
          <CopyIngredientsButton content={recipe.content} />
        </div>
        <ReactMarkdown remarkPlugins={[remarkGfm]}>{afterIngredients}</ReactMarkdown>
      </article>
    );
  }

  // Fallback: current behavior (button at bottom)
  return (
    <article className="prose prose-zinc max-w-3xl">
      <h1>{recipe.title}</h1>
      <ReactMarkdown remarkPlugins={[remarkGfm]}>{recipe.content}</ReactMarkdown>
      <div className="not-prose my-6">
        <CopyIngredientsButton content={recipe.content} />
      </div>
    </article>
  );
}
```

**Alternative approach (simpler):**
Use a remark plugin to inject the button component directly into the markdown AST after the Ingredients heading. This is more complex but cleaner.

**Recommended approach for MVP:**
Use the content splitting approach above for simplicity. Can refactor to remark plugin later if needed.

### Existing Pattern Reference

- DevBanner component: `src/components/layout/DevBanner.tsx`
- RecipeDisplay component: `src/components/recipe/RecipeDisplay.tsx`
- CopyIngredientsButton: `src/components/recipe/CopyIngredientsButton.tsx`
- shadcn/ui Button: Already in use
- localStorage pattern: Similar to theme persistence

### Key Constraints

- Banner dismiss must persist across sessions (localStorage required)
- Copy button must still extract all ingredients correctly (don't break existing logic)
- If ingredients heading not found, must gracefully fall back to current behavior
- Dismiss button must be touch-friendly on mobile (minimum 44x44px tap target)
- Copy button placement should work with existing markdown rendering

## Definition of Done

- [x] Functional requirements met (banner dismissible, copy button repositioned)
- [x] Integration requirements verified (existing components unchanged, localStorage persists)
- [x] Existing functionality regression tested (copy ingredients works, banner displays on first visit)
- [x] Code follows existing patterns and standards (React state, shadcn/ui, TypeScript)
- [x] Tests pass (DevBanner dismiss, RecipeDisplay button placement)
- [x] Manual testing completed (dismiss banner, verify copy button position)
- [x] Accessibility verified (dismiss button has ARIA label, keyboard accessible)

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Content splitting for copy button placement could break markdown rendering or cause layout issues

**Mitigation:**
- Test with multiple recipes (with and without "Ingredients" heading)
- Verify markdown rendering still works correctly (lists, formatting, etc.)
- Use fallback to current behavior if heading not found
- Add unit tests for content splitting logic

**Secondary Risk:** Banner dismiss state could interfere with future banner updates/messages

**Mitigation:**
- Use versioned localStorage key if needed (e.g., `banner-dismissed-v1`)
- Consider adding banner version/message ID to localStorage value
- For MVP, simple boolean is sufficient

**Rollback:** Revert DevBanner and RecipeDisplay components via git

### Compatibility Verification

- [x] No breaking changes to existing APIs (component props unchanged)
- [x] Database changes (if any) are additive only (N/A - localStorage only)
- [x] UI changes follow existing design patterns (shadcn/ui Button, React state)
- [x] Performance impact is negligible (content parsing is fast, one-time per render)

## Validation Checklist

### Scope Validation

- [x] Story can be completed in one development session (2-4 hours)
- [x] Integration approach is straightforward (state management + content parsing)
- [x] Follows existing patterns exactly (React hooks, shadcn/ui components)
- [x] No design or architecture work required (UI polish only)

### Clarity Check

- [x] Story requirements are unambiguous (2 specific features with clear behavior)
- [x] Integration points are clearly specified (DevBanner, RecipeDisplay, localStorage)
- [x] Success criteria are testable (banner dismisses, button repositioned, persistence works)
- [x] Rollback approach is simple (git revert two components)

## Testing Guidance

### Component Tests

```typescript
// DevBanner.test.tsx
describe('DevBanner', () => {
  beforeEach(() => {
    localStorage.clear();
  });

  test('renders banner by default', () => {
    render(<DevBanner />);
    expect(screen.getByText(/work in progress/i)).toBeInTheDocument();
  });

  test('renders dismiss button', () => {
    render(<DevBanner />);
    expect(screen.getByLabelText('Dismiss banner')).toBeInTheDocument();
  });

  test('dismissing banner hides it', () => {
    render(<DevBanner />);
    const dismissButton = screen.getByLabelText('Dismiss banner');
    fireEvent.click(dismissButton);
    expect(screen.queryByText(/work in progress/i)).not.toBeInTheDocument();
  });

  test('dismiss state persists to localStorage', () => {
    render(<DevBanner />);
    const dismissButton = screen.getByLabelText('Dismiss banner');
    fireEvent.click(dismissButton);
    expect(localStorage.getItem('recipe-archive-banner-dismissed')).toBe('true');
  });

  test('does not render if previously dismissed', () => {
    localStorage.setItem('recipe-archive-banner-dismissed', 'true');
    render(<DevBanner />);
    expect(screen.queryByText(/work in progress/i)).not.toBeInTheDocument();
  });
});

// RecipeDisplay.test.tsx
describe('RecipeDisplay copy button placement', () => {
  test('renders copy button below Ingredients heading', () => {
    const recipe = {
      title: 'Test Recipe',
      content: '## Ingredients\n- Flour\n- Sugar\n\n## Instructions\nMix ingredients',
    };
    render(<RecipeDisplay recipe={recipe} />);
    // Verify button appears after Ingredients heading
    // This may require DOM traversal or test IDs
  });

  test('falls back to bottom placement if no Ingredients heading', () => {
    const recipe = {
      title: 'Test Recipe',
      content: 'Just some recipe content without headings',
    };
    render(<RecipeDisplay recipe={recipe} />);
    // Verify button appears at bottom
  });

  test('copy button still extracts ingredients correctly', () => {
    const recipe = {
      title: 'Test Recipe',
      content: '## Ingredients\n- Flour\n- Sugar\n\n## Instructions\nMix',
    };
    render(<RecipeDisplay recipe={recipe} />);
    const copyButton = screen.getByRole('button', { name: /copy ingredients/i });
    // Test clipboard functionality still works
  });
});
```

### Manual Testing Checklist

**Dismissible Banner:**
- [ ] Banner displays with dismiss X button on first visit
- [ ] Dismiss button is in top left corner of banner
- [ ] Clicking dismiss button hides banner immediately
- [ ] Page refresh shows no banner (localStorage persists)
- [ ] Clearing localStorage brings banner back
- [ ] Dismiss button is keyboard accessible (Tab + Enter)
- [ ] Dismiss button works on mobile (touch-friendly)

**Copy Button Placement:**
- [ ] Open recipe with "## Ingredients" heading
- [ ] Verify copy button appears immediately below heading
- [ ] Verify copy button still copies all ingredients correctly
- [ ] Open recipe without "Ingredients" heading
- [ ] Verify copy button appears at bottom (fallback behavior)
- [ ] Test in both light and dark themes (visual verification)
- [ ] Test on mobile - button accessible without excessive scrolling

**Integration:**
- [ ] Banner dismiss doesn't affect copy button
- [ ] Copy button placement doesn't affect banner
- [ ] Both features work correctly together
- [ ] No console errors or warnings
