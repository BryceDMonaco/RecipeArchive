# Story 4.2: Print and Search Functionality Fixes - Brownfield Addition

## User Story

**As a** user,
**I want** to print multi-page recipes successfully and get accurate search results,
**So that** I can have complete printed recipe cards and quickly find the specific recipes I'm looking for.

## Story Context

### Existing System Integration

- **Integrates with:**
  - Print CSS (`src/index.css` or component-level `@media print` styles)
  - Search functionality (`src/hooks/useRecipeFilter.ts` using fuse.js)
  - RecipeDisplay component (`src/components/recipe/RecipeDisplay.tsx`)
- **Technology:** CSS `@media print`, fuse.js fuzzy search, React hooks
- **Follows pattern:** CSS media query best practices, fuse.js configuration options
- **Touch points:**
  - Print CSS media queries
  - fuse.js options (threshold, keys, weights)
  - useRecipeFilter hook search logic

### Bugs to Fix

1. **Print Pagination:** Print view stops at one page even when recipe content is longer than one page
2. **Search Accuracy:** Search returns all recipes for specific queries that should match only one recipe:
   - Searching "bread" returns all 5 test recipes (only 1 has "bread" in title/tags/content)
   - Searching "asian" returns all 5 test recipes (only 1 has "asian" tag)

## Acceptance Criteria

### Functional Requirements

1. Multi-page recipes print across multiple pages correctly (no content cut off)
2. Print CSS maintains page breaks intelligently (avoids breaking ingredient lists or instruction steps mid-item)
3. Search query "bread" returns only recipes containing "bread" in title, tags, or content
4. Search query "asian" returns only recipes with "asian" tag or containing "asian" in title/content
5. Search behavior is consistent and predictable (fuzzy matching tolerates typos but doesn't match unrelated terms)

### Integration Requirements

6. Existing print CSS for hiding sidebar/buttons remains functional
7. New print pagination doesn't break single-page recipe printing
8. Search changes maintain real-time filtering behavior (updates as user types)
9. Integration with tag filtering continues to work (search + tag filters work together)
10. fuse.js configuration follows existing pattern (keys, weights, options)

### Quality Requirements

11. Changes are covered by unit tests (search accuracy tests)
12. Manual testing performed for print on Chrome, Firefox, Safari
13. No regression in existing search or print functionality verified
14. Search performance remains fast (no noticeable lag)

## Technical Notes

### Integration Approach

**Print Pagination Fix:**

Problem: Likely caused by `overflow: hidden` or height constraints on print media query
Solution:
- Review print CSS in `@media print` queries
- Remove height constraints on main content area (allow natural document flow)
- Add CSS to enable page breaks:
  ```css
  @media print {
    html, body {
      height: auto;
      overflow: visible;
    }
    article {
      max-height: none;
      overflow: visible;
    }
    /* Prevent page breaks inside ingredients/instructions */
    ul, ol {
      page-break-inside: avoid;
    }
    h2, h3 {
      page-break-after: avoid;
    }
  }
  ```

**Search Accuracy Fix:**

Problem: fuse.js threshold is too high (0.4 is very permissive) causing false positives
Solution:
- Lower threshold from 0.4 to 0.2 or 0.3 (stricter matching)
- Consider adjusting `minMatchCharLength` to require longer match sequences
- Review `ignoreLocation: true` - this might be causing matches anywhere in content
- Test with actual recipe data to find optimal threshold

Current config (`src/hooks/useRecipeFilter.ts` lines 5-14):
```typescript
const fuseOptions: IFuseOptions<SearchableRecipeMetadata> = {
  keys: [
    { name: 'title', weight: 0.5 },
    { name: 'tags', weight: 0.3 },
    { name: 'content', weight: 0.2 },
  ],
  threshold: 0.4,  // TOO HIGH - change to 0.2 or 0.3
  ignoreLocation: true,
  minMatchCharLength: 2,
};
```

Recommended new config:
```typescript
const fuseOptions: IFuseOptions<SearchableRecipeMetadata> = {
  keys: [
    { name: 'title', weight: 0.5 },
    { name: 'tags', weight: 0.3 },
    { name: 'content', weight: 0.2 },
  ],
  threshold: 0.3,  // Stricter matching
  ignoreLocation: true,
  minMatchCharLength: 3,  // Require at least 3 characters to match
};
```

### Existing Pattern Reference

- fuse.js documentation: https://fusejs.io/api/options.html
- Print CSS best practices: https://www.smashingmagazine.com/2018/05/print-stylesheets-in-2018/
- Current search implementation: `src/hooks/useRecipeFilter.ts`
- Current print styles: Check `src/index.css` or component-level styles

### Key Constraints

- Must not break existing search fuzzy matching (should still tolerate minor typos)
- Print changes must not affect screen display styling
- Search performance must remain fast (< 100ms for typical queries)
- Changes must be backwards compatible with existing recipe metadata format

## Definition of Done

- [x] Functional requirements met (multi-page printing, accurate search results)
- [x] Integration requirements verified (print CSS intact, search + tag filters work together)
- [x] Existing functionality regression tested (single-page prints, fuzzy matching for typos)
- [x] Code follows existing patterns and standards (fuse.js config, CSS media queries)
- [x] Tests pass (unit tests for search accuracy, manual print testing)
- [x] Manual testing completed on Chrome, Firefox, Safari print functions
- [x] Search tested with multiple queries ("bread", "asian", intentional typos)

## Risk and Compatibility Check

### Minimal Risk Assessment

**Primary Risk:** Lowering fuse.js threshold could make search too strict, breaking fuzzy matching for typos

**Mitigation:**
- Test search with both exact matches and intentional typos (e.g., "bred" should still find "bread")
- Start with threshold 0.3, adjust to 0.2 only if needed
- Add unit tests for expected search behavior (exact matches, fuzzy matches, non-matches)

**Secondary Risk:** Print CSS changes could break desktop/mobile layout

**Mitigation:**
- Use `@media print` queries exclusively (no effect on screen styles)
- Test print preview in multiple browsers
- Verify screen layout unchanged after CSS changes

**Rollback:** Revert `useRecipeFilter.ts` fuse config and print CSS changes via git

### Compatibility Verification

- [x] No breaking changes to existing APIs (useRecipeFilter hook signature unchanged)
- [x] Database changes (if any) are additive only (N/A - no database)
- [x] UI changes follow existing design patterns (CSS media queries)
- [x] Performance impact is negligible (fuse.js threshold change has minimal performance impact)

## Validation Checklist

### Scope Validation

- [x] Story can be completed in one development session (2-4 hours)
- [x] Integration approach is straightforward (config change + CSS addition)
- [x] Follows existing patterns exactly (fuse.js options, print CSS)
- [x] No design or architecture work required (bug fixes only)

### Clarity Check

- [x] Story requirements are unambiguous (2 specific bugs with clear expected behavior)
- [x] Integration points are clearly specified (useRecipeFilter, print CSS)
- [x] Success criteria are testable (print preview, search query tests)
- [x] Rollback approach is simple (git revert two files)

## Testing Guidance

### Unit Tests

```typescript
// Add to useRecipeFilter.test.ts (or create if doesn't exist)
describe('Search accuracy', () => {
  test('searching "bread" returns only recipes containing "bread"', () => {
    // Test with mock recipe data
  });

  test('searching "asian" returns only recipes with "asian" tag or content', () => {
    // Test with mock recipe data
  });

  test('fuzzy matching still works for typos', () => {
    // Test "bred" still finds "bread" recipe
  });

  test('empty search returns all recipes', () => {
    // Test existing behavior maintained
  });
});
```

### Manual Testing Checklist

**Print Functionality:**
- [ ] Print single-page recipe (verify no regression)
- [ ] Print multi-page recipe (2+ pages)
- [ ] Verify page breaks don't split ingredient lists awkwardly
- [ ] Verify page breaks don't split instruction steps mid-sentence
- [ ] Test print preview in Chrome, Firefox, Safari

**Search Accuracy:**
- [ ] Search "bread" - verify only recipes with "bread" appear
- [ ] Search "asian" - verify only recipes with "asian" tag/content appear
- [ ] Search intentional typo "bred" - verify "bread" recipe still appears (fuzzy match)
- [ ] Search nonsense term "xyz123" - verify no results (or empty state message)
- [ ] Combine search with tag filter - verify both filters apply correctly
